本项目出自阿里天池竞赛[零基础入门CV - 街景字符编码识别](https://tianchi.aliyun.com/competition/entrance/531795/information)学习赛。

本项目参考了其他选手的一些处理技巧，使用yolov8框架进行训练。截至2024年4月29日，分数为0.9476，排名5/7496

参考资料：

[动手学CV-Pytorch](https://datawhalechina.github.io/dive-into-cv-pytorch/#/?id=dive-into-cv-pytorch)

[YOLOV8官方文档](https://docs.ultralytics.com/)

[Albumentations库说明文档](https://albumentations.ai/docs/)



## 快速开始

### 快速创建环境

进入environment.yml文件所在的文件夹，使用以下命令创建环境并安装所需库：

```python
conda env create -f environment.yml
```

注意：部分库是没有必要安装的，可以在使用命令前手动打开文件进行删除

### 数据预处理

标注文件转为yolo格式，无特殊处理

------------------------------------------

### 模型选择

使用yolov8m预训练模型及其架构，在30000张图片上训练100个周期，线上分数为0.922，以此分数作为基准进行优化。

| 主要参数 |     说明     | 配置 |
| :------: | :----------: | :--: |
|  epochs  |   训练周期   | 100  |
|  imgsz   | 图片输入大小 | 320  |
| patience |   早停周期   | 100  |

-------------------------------------------

| 模型 | 额外处理 | 线上分数 |
| :-: | :-: | :-: |
| yolov8m | 无 | 0.9222 |
| yolov8m | 调整了置信度与交并比 | 0.9354 |
| yolov8x | 调整了置信度与交并比 |  0.9325  |

**注意：** 额外处理是相对于yolov8m这一预训练模型所做出的改动

---------------------------------------

### 训练

取消早停/调高早停周期(默认50，周期不大于50不用调整)，尽量增加训练轮次。模型一般会在10~15个周期之间收敛，过多的训练轮次对于快速迭代改进没有帮助(不会显著增加线上分数)，当难以有较大的提升时，可以尝试额外增加训练轮次。

-----------------------

### 验证

验证集部分图片存在错误标注的情况，主要体现在重复字符未能标注。例如验证集000023.png与000025.png：

![image](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/c9f40cf9-c0b5-4c5d-a70b-9b3bd4d1d2c5)
 其标注为26，但实际上为260

![image](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/d6498423-e280-4cf1-aa79-03606bc4e81c)
 其标注为20，但实际上为2020

这是模型在验证集上的表现(MAP)难以超过0.93的主要原因之一。其测试集中也可能存在类似问题(其导致的误差对线上评分的影响应该在0.02~0.05之间)。

**如何评估并降低这种误差在训练与评估中的影响：**

1. 从训练集与验证集中各抽出5000张(共10000张)作为验证集，剩余原先的5000张验证图片作为测试集。通过比较验证集与测试集的表现来评估这种标注错误所造成的影响，进而确定改进方向。
2. 将验证集全部放入训练集，随机抽取作为新的验证集

**注意：** 降低标注错误造成的影响十分重要，因为YOLOV8会使用验证集的评估来保存最好的模型


----------------------------------------

### 数据增强

yolov8属于**端到端**学习，这种学习方式往往需要大量的图片数据(高质量数据)

仅使用了yolov8m作为基准模型，未采用更大模型进行测试

|处理方式|线上分数|
|:-:|:-:|
|调整参数|0.9361|
|扩充图片|0.9370、0.9476|

------------------------------------------
**调整细节**

均在基模型的基础上训练50周期

| 处理方式 | 操作                                         | 原因 | 效果 |
| :------: | :------------------------------------------- | ---- | ---- |
| 调整参数 | 参考yolov8官方文档修改数据增强参数，略微调整 | 凭感觉 | 略微上升 |
| 扩充图片 | 1. 将验证集图片的80%加入训练集               | 验证集部分图片缺少标注 | 略微上升 |
|扩充图片|2. 全部图片反转、略微旋转、略微模糊|部分验证集图像模糊，模型对验证集中倾斜、模糊等类型图片识别效果不好|略微下降|
|扩充图片|3. 在2的基础上（操作方式）对类别1、2、3扩充2倍，其余1倍|部分类别识别效果不好|略微下降|
|扩充图片|4. 全部图片剧烈变化，添加缩放等多种操作，扩充至10万张，略微降低图片拼接(马赛克增强)等参数|测试集图片字符较大，且在中心位置；2、3操作效果不好|较大上升|
|扩充图片|5. 在4的基础上扩充至50万张，调整操作3扩充倍数。训练集中的验证集图片不进行扩充。操作2中训练集错误图片抽出并扩充10倍。不要让数据类别过于倾斜|操作4表现较好；部分图片学习困难|较大上升|

**其它方式：** 对全部图片降噪处理，测试集图片似乎比训练集图片更清晰(也可能是测试集图片多导致的错觉)

**重要增强方式**

由于全部的操作是放在一起的，例如同时进行缩放、旋转、模糊等操作，所以无法具体确定是其中哪一个有着很好的效果。

| 方式 | 原因                                                         |
| :--: | :----------------------------------------------------------- |
| 缩放 | 测试集图片字符普遍较大，且大多处在中心位置。在验证集上，字符相对于背景较小的图片识别效果不好，容易对背景误识别 |
| 旋转 | 在验证集上，模型对偏斜的字符检测效果不佳。偏斜图片会让字符看起来相隔很近，导致检测到重复字符 |
| 模糊 | 字符小的图片大多是模糊的                                     |
| 其它 | 调整了YOLOV8默认的数据增强参数。例如降低了图像拼接(马赛克增强)被使用的概率。降噪、饱和度、亮度等其它处理技术 |

---------------------------------

### 输出处理

| 处理方式                                                     |
| ------------------------------------------------------------ |
| iou=0.5, conf=0.001, agnostic_nms=True                           线上分数：0.9287-->0.9354 |
| 输出字符顺序按照图片框中心点进行排序                            conf > 0.15 |
| 未进行模型融合--例如多模型投票、单模型对单张图片裁剪预测、滚动预测等 |

| 其他处理方式                         | 结果                                       |    线上分数     |
| ------------------------------------ | ------------------------------------------ | :-------------: |
| 对全部重复字符过滤：例如2020过滤为20 | 这是个馊主意，因为测试集只有小部分标注错误 | 0.9476-->0.7946 |
| 转ONNX模型                           | 这同样是个馊主意，增加了几十倍的推理时长   |                 |

**提示：** 参数部分请查看官方文档或查看GitHub中翻译过的中文文档(在[说明](https://github.com/shenmi175/SVHN-TianChi/tree/main/说明)这一文件夹中)

---------------------------------------

### 模型学习/验证难点

1. 字符偏斜，导致检测到重复字符

2. 结构式标注错误(部分重复字符缺少标注)。例训练集000132.png:

![image](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/a62ff55c-d389-4f0e-908c-1dc6b4cd88ec) 其标注为44

3. 背景环境影响。例验证集000003.png：

![image](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/cc7168b2-269d-4524-9817-6569828eff0f) 其标注为1，但1的外围存在一个类似于0的边框，检测结果为01；

门把手、栅栏、墙壁间的砖缝等也容易被识别为数字1(其中有标注框的影响；如果将置信度设置的很低，也会产生更多误识别)

![image](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/7edfe74c-f6f5-44a0-81b0-9c54250a9370) 其检测结果为813

4. 字符本身。大多数字符是标准的7，但部分字符(墙壁涂鸦)会在7的中间加上‘-’。这导致部分7被识别为7和1。

字符3和8由于偏斜/模糊等原因被错误识别等

**注意：** 以上是存在于训练集与验证集的问题。其改进方向应聚焦于缩小三个数据集图片的差异性并降低背景造成的影响。仅仅是更换模型、降低学习率、更改优化器、增加训练轮次、进行常规的数据增强是不太可能有较大提升的。

-------------

### 利用偏差&方差进行改进

当你的模型在测试集上表现不好时，可能会尝试以下方式进行改进，但并不一定是有效的

|            常见改进方式             |
| :---------------------------------: |
|   利用数据扩充、爬取获得更多数据    |
|     利用数据增强增加数据多样性      |
|            增加训练周期             |
|    使用不同的优化器、降低学习率     |
|      使用更大、更新的神经网络       |
|         加入正则化/Dropout          |
| 修改神经网络结构--激活函数/隐藏单元 |
|               ······                |

**最好的方法是利用偏差、方差、线上评分来评估三者之间的差距，哪个差距大就着重优化哪一方向**

----------------


## 最终排名
![2024-4-29-分数-排名](https://github.com/shenmi175/SVHN-TianChi/assets/102409368/52eb72a2-a9a6-4e27-a9bd-c9fac2789cde)


